const g="pit-195d44e7-6b55-4e86-aa33-1c039d458e5c",l="aLTXtdwNknfmEFo3WBIX",S="estimate";function x(r){if(!r||typeof r!="object")return!1;const{name:c,email:u,phone:d,address:n,postcode:t}=r;if(!c||!u||!d||!n||!t)return!1;const e=/.+@.+\..+/.test(u),s=/^(\+?61|0)[0-9\s-]{8,}$/.test(d);return e&&s}async function P(r){if(!x(r))return{success:!1,error:"Invalid payload"};const c=String(r.name).trim().split(/\s+/),u=c[0]||"",d=c.length>1?c.slice(1).join(" "):"",n={firstName:u,lastName:d,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Lead Form",tags:["Website Lead"],locationId:l,customFields:[]};if(r.productContext){const t=r.productContext;n.customFields.push({key:"product_name",field_value:t.productName||`${t.productType} ${t.context} System`},{key:"product_type",field_value:t.productType},{key:"product_context",field_value:t.context},{key:"estimated_total",field_value:t.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(t.selectedAddons)?t.selectedAddons.join(", "):""}),n.tags.push(`Product: ${t.productType}`,`Context: ${t.context}`)}if(r.propertyContext){const t=r.propertyContext;n.customFields.push({key:"property_type",field_value:t.propertyType},{key:"building_type",field_value:t.buildingType}),t.storeyType&&n.customFields.push({key:"storey_type",field_value:t.storeyType}),t.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:t.ceilingType}),n.tags.push(`Property: ${t.propertyType}`,`Building: ${t.buildingType}`)}try{const t=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),e=await t.text();let s=null;try{s=JSON.parse(e)}catch{s=null}if(!t.ok){const i=(s==null?void 0:s.error)||(s==null?void 0:s.message)||e||"Unknown error";return{success:!1,error:`GHL API failed: ${t.status} - ${i}`}}return{success:!0,data:s}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async function U(r,c=S){var u;if(!x(r))return{success:!1,error:"Invalid contact payload"};if(!((u=r.productContext)!=null&&u.cart)||!Array.isArray(r.productContext.cart)||r.productContext.cart.length===0)return{success:!1,error:"Empty cart after normalization"};try{const d=await b(r);if(!d.success)return{success:!1,error:`Contact creation failure: ${d.error}`};const n=d.contactId,t=await A(n,r,c);return t.success?{success:!0,type:c,id:t.id,url:t.url||null}:{success:!1,error:`Draft creation failure: ${t.error}`}}catch(d){return{success:!1,error:d instanceof Error?d.message:"Unknown error"}}}async function b(r){var t;const c=String(r.name).trim().split(/\s+/),u=c[0]||"",d=c.length>1?c.slice(1).join(" "):"";try{const e=await fetch(`https://services.leadconnectorhq.com/contacts/search/duplicate?locationId=${l}&email=${encodeURIComponent(r.email)}`,{method:"GET",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(e.ok){const s=await e.json();if(s.contact&&s.contact.id)return{success:!0,contactId:s.contact.id}}}catch{}const n={firstName:u,lastName:d,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Calculator",tags:["Website Lead","Calculator Quote"],locationId:l,customFields:[]};if(r.productContext){const e=r.productContext;n.customFields.push({key:"product_name",field_value:e.productName||`${e.productType} ${e.context} System`},{key:"product_type",field_value:e.productType},{key:"product_context",field_value:e.context},{key:"estimated_total",field_value:e.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(e.selectedAddons)?e.selectedAddons.join(", "):""}),n.tags.push(`Product: ${e.productType}`,`Context: ${e.context}`)}if(r.propertyContext){const e=r.propertyContext;n.customFields.push({key:"property_type",field_value:e.propertyType},{key:"building_type",field_value:e.buildingType}),e.storeyType&&n.customFields.push({key:"storey_type",field_value:e.storeyType}),e.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:e.ceilingType}),n.tags.push(`Property: ${e.propertyType}`,`Building: ${e.buildingType}`)}try{const e=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),s=await e.text();let i=null;try{i=JSON.parse(s)}catch{i=null}if(!e.ok){if(e.status===400&&(s.includes("duplicate")||s.includes("already exists")))try{const m=await fetch(`https://services.leadconnectorhq.com/contacts/?locationId=${l}&query=${encodeURIComponent(r.email)}`,{method:"GET",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(m.ok){const f=await m.json();if(f.contacts&&f.contacts.length>0){const h=f.contacts.find(p=>p.email===r.email);if(h)return{success:!0,contactId:h.id}}}}catch{}const _=(i==null?void 0:i.error)||(i==null?void 0:i.message)||s||"Unknown error";return{success:!1,error:`${e.status} - ${_}`}}const y=((t=i==null?void 0:i.contact)==null?void 0:t.id)||(i==null?void 0:i.id);return y?{success:!0,contactId:y}:{success:!1,error:"No contact ID returned from GHL"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async function A(r,c,u){var i,y,_,m,f,h;const d=N(c.productContext.cart,c.productContext.context),n=new Date,t=n.toISOString().split("T")[0],e=new Date(n.getTime()+30*24*60*60*1e3).toISOString().split("T")[0],s={altId:l,altType:"location",name:`${u==="estimate"?"Estimate":"Invoice"} - ${c.name||"Customer"}`,title:u==="estimate"?"ESTIMATE":"INVOICE",businessDetails:{name:"Cheap Alarms",address:{addressLine1:"Cheap Alarms Pty Ltd",city:"Brisbane",state:"QLD",postalCode:"4000",countryCode:"AU"}},currency:"USD",items:d,discount:{type:"percentage",value:0},termsNotes:"<p>Quote generated from website configurator.</p>",contactDetails:{id:r,name:c.name,email:c.email,phoneNo:(i=c.phone)!=null&&i.startsWith("+")?c.phone:`+61${((y=c.phone)==null?void 0:y.replace(/^0/,""))||""}`,address:{addressLine1:c.address||"Address not provided",city:"TBD",state:"TBD",postalCode:c.postcode||"TBD",countryCode:"AU"}},issueDate:t,expiryDate:e,frequencySettings:{enabled:!1},liveMode:!0};try{const p=await fetch("/wp-json/ca/v1/estimate/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),$=await p.text();let T=null;try{T=JSON.parse($)}catch{}if(p.ok&&(T!=null&&T.ok)){const a=T.result||{},C=((_=a==null?void 0:a.estimate)==null?void 0:_.id)||(a==null?void 0:a._id)||(a==null?void 0:a.id),D=((m=a==null?void 0:a.estimate)==null?void 0:m.liveUrl)||(a==null?void 0:a.liveUrl)||(a==null?void 0:a.url)||null;if(C&&l)try{await fetch("/wp-json/ca/v1/estimate/annotate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({estimateId:C,locationId:l})})}catch{}return C?{success:!0,id:C,url:D}:{success:!1,error:"Bridge create succeeded but no estimate ID"}}const v=await fetch(`https://services.leadconnectorhq.com/invoices/${u==="estimate"?"estimate":""}`,{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(s)}),k=await v.text();let o=null;try{o=JSON.parse(k)}catch{}if(!v.ok){const a=(o==null?void 0:o.error)||(o==null?void 0:o.message)||k||"Unknown error";return{success:!1,error:`${v.status} - ${a}`}}const I=(o==null?void 0:o._id)||((f=o==null?void 0:o.estimate)==null?void 0:f.id)||(o==null?void 0:o.id),w=(o==null?void 0:o.liveUrl)||((h=o==null?void 0:o.estimate)==null?void 0:h.liveUrl)||(o==null?void 0:o.url);if(!I)return{success:!1,error:"No document ID returned from GHL"};try{await fetch("/wp-json/ca/v1/estimate/annotate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({estimateId:I,locationId:l})})}catch{}return{success:!0,id:I,url:w}}catch(p){return{success:!1,error:p instanceof Error?p.message:"Network error"}}}function N(r,c){var t;const u=[];for(const e of r){let s=0;typeof e.unitPrice=="object"&&e.unitPrice!==null&&e.unitPrice[c]?s=e.unitPrice[c]:typeof e.unitPrice=="number"&&(s=e.unitPrice);const i={name:e.name||"Unknown Item",description:e.description||"One-off service",amount:Math.round(s),qty:e.qty||e.quantity||1,type:"one_time",taxInclusive:!0,currency:"USD"};u.push(i)}const d=u.reduce((e,s)=>e+s.amount*s.qty,0),n=(t=r.find(e=>e.targetTotal))==null?void 0:t.targetTotal;if(n&&n<d){const e=d-n;u.push({name:"Discount",description:"Applied discount to reach target price",amount:-e,qty:1,type:"one_time",taxInclusive:!0,currency:"USD"})}return u}export{U as createDraftDocument,P as submitLeadToGHL};
