const T="pit-195d44e7-6b55-4e86-aa33-1c039d458e5c",d="aLTXtdwNknfmEFo3WBIX",D="estimate";function x(o){if(!o||typeof o!="object")return!1;const{name:s,email:u,phone:l,address:n,postcode:t}=o;if(!s||!u||!l||!n||!t)return!1;const e=/.+@.+\..+/.test(u),r=/^(\+?61|0)[0-9\s-]{8,}$/.test(l);return e&&r}async function P(o){if(!x(o))return{success:!1,error:"Invalid payload"};const s=String(o.name).trim().split(/\s+/),u=s[0]||"",l=s.length>1?s.slice(1).join(" "):"",n={firstName:u,lastName:l,email:o.email,phone:o.phone,address1:o.address,postalCode:o.postcode,source:"Website Lead Form",tags:["Website Lead"],locationId:d,customFields:[]};if(o.productContext){const t=o.productContext;n.customFields.push({key:"product_name",field_value:t.productName||`${t.productType} ${t.context} System`},{key:"product_type",field_value:t.productType},{key:"product_context",field_value:t.context},{key:"estimated_total",field_value:t.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(t.selectedAddons)?t.selectedAddons.join(", "):""}),n.tags.push(`Product: ${t.productType}`,`Context: ${t.context}`)}if(o.propertyContext){const t=o.propertyContext;n.customFields.push({key:"property_type",field_value:t.propertyType},{key:"building_type",field_value:t.buildingType}),t.storeyType&&n.customFields.push({key:"storey_type",field_value:t.storeyType}),t.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:t.ceilingType}),n.tags.push(`Property: ${t.propertyType}`,`Building: ${t.buildingType}`)}try{const t=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),e=await t.text();let r=null;try{r=JSON.parse(e)}catch{r=null}if(!t.ok){const i=(r==null?void 0:r.error)||(r==null?void 0:r.message)||e||"Unknown error";return{success:!1,error:`GHL API failed: ${t.status} - ${i}`}}return{success:!0,data:r}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async function U(o,s=D){var u;if(!x(o))return{success:!1,error:"Invalid contact payload"};if(!((u=o.productContext)!=null&&u.cart)||!Array.isArray(o.productContext.cart)||o.productContext.cart.length===0)return{success:!1,error:"Empty cart after normalization"};try{const l=await S(o);if(!l.success)return{success:!1,error:`Contact creation failure: ${l.error}`};const n=l.contactId,t=await A(n,o,s);return t.success?{success:!0,type:s,id:t.id,url:t.url||null}:{success:!1,error:`Draft creation failure: ${t.error}`}}catch(l){return{success:!1,error:l instanceof Error?l.message:"Unknown error"}}}async function S(o){var t;const s=String(o.name).trim().split(/\s+/),u=s[0]||"",l=s.length>1?s.slice(1).join(" "):"";try{const e=await fetch(`https://services.leadconnectorhq.com/contacts/search/duplicate?locationId=${d}&email=${encodeURIComponent(o.email)}`,{method:"GET",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(e.ok){const r=await e.json();if(r.contact&&r.contact.id)return console.log("Found existing contact:",r.contact.id),{success:!0,contactId:r.contact.id}}}catch(e){console.warn("Contact search failed, proceeding with creation:",e.message)}const n={firstName:u,lastName:l,email:o.email,phone:o.phone,address1:o.address,postalCode:o.postcode,source:"Website Calculator",tags:["Website Lead","Calculator Quote"],locationId:d,customFields:[]};if(o.productContext){const e=o.productContext;n.customFields.push({key:"product_name",field_value:e.productName||`${e.productType} ${e.context} System`},{key:"product_type",field_value:e.productType},{key:"product_context",field_value:e.context},{key:"estimated_total",field_value:e.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(e.selectedAddons)?e.selectedAddons.join(", "):""}),n.tags.push(`Product: ${e.productType}`,`Context: ${e.context}`)}if(o.propertyContext){const e=o.propertyContext;n.customFields.push({key:"property_type",field_value:e.propertyType},{key:"building_type",field_value:e.buildingType}),e.storeyType&&n.customFields.push({key:"storey_type",field_value:e.storeyType}),e.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:e.ceilingType}),n.tags.push(`Property: ${e.propertyType}`,`Building: ${e.buildingType}`)}try{const e=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),r=await e.text();let i=null;try{i=JSON.parse(r)}catch{i=null}if(!e.ok){if(e.status===400&&(r.includes("duplicate")||r.includes("already exists"))){console.log("Duplicate contact detected, attempting to find existing contact...");try{const p=await fetch(`https://services.leadconnectorhq.com/contacts/?locationId=${d}&query=${encodeURIComponent(o.email)}`,{method:"GET",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(p.ok){const f=await p.json();if(f.contacts&&f.contacts.length>0){const y=f.contacts.find(m=>m.email===o.email);if(y)return console.log("Found existing contact via search:",y.id),{success:!0,contactId:y.id}}}}catch(p){console.warn("Fallback contact search failed:",p.message)}}const C=(i==null?void 0:i.error)||(i==null?void 0:i.message)||r||"Unknown error";return{success:!1,error:`${e.status} - ${C}`}}const h=((t=i==null?void 0:i.contact)==null?void 0:t.id)||(i==null?void 0:i.id);return h?{success:!0,contactId:h}:{success:!1,error:"No contact ID returned from GHL"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async function A(o,s,u){var i,h,C,p,f,y;const l=N(s.productContext.cart,s.productContext.context),n=new Date,t=n.toISOString().split("T")[0],e=new Date(n.getTime()+30*24*60*60*1e3).toISOString().split("T")[0],r={altId:d,altType:"location",name:`${u==="estimate"?"Estimate":"Invoice"} - ${s.name||"Customer"}`,title:u==="estimate"?"ESTIMATE":"INVOICE",businessDetails:{name:"Cheap Alarms",address:{addressLine1:"Cheap Alarms Pty Ltd",city:"Brisbane",state:"QLD",postalCode:"4000",countryCode:"AU"}},currency:"USD",items:l,discount:{type:"percentage",value:0},termsNotes:"<p>Quote generated from website configurator.</p>",contactDetails:{id:o,name:s.name,email:s.email,phoneNo:(i=s.phone)!=null&&i.startsWith("+")?s.phone:`+61${((h=s.phone)==null?void 0:h.replace(/^0/,""))||""}`,address:{addressLine1:s.address||"Address not provided",city:"TBD",state:"TBD",postalCode:s.postcode||"TBD",countryCode:"AU"}},issueDate:t,expiryDate:e,frequencySettings:{enabled:!1},liveMode:!0};try{const m=await fetch("/wp-json/ca/v1/estimate/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),k=await m.text();let g=null;try{g=JSON.parse(k)}catch{}if(m.ok&&(g!=null&&g.ok)){const a=g.result||{},_=((C=a==null?void 0:a.estimate)==null?void 0:C.id)||(a==null?void 0:a._id)||(a==null?void 0:a.id),b=((p=a==null?void 0:a.estimate)==null?void 0:p.liveUrl)||(a==null?void 0:a.liveUrl)||(a==null?void 0:a.url)||null;if(_&&d)try{await fetch("/wp-json/ca/v1/estimate/annotate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({estimateId:_,locationId:d})})}catch{}return _?{success:!0,id:_,url:b}:{success:!1,error:"Bridge create succeeded but no estimate ID"}}const v=await fetch(`https://services.leadconnectorhq.com/invoices/${u==="estimate"?"estimate":""}`,{method:"POST",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(r)}),$=await v.text();let c=null;try{c=JSON.parse($)}catch{}if(!v.ok){const a=(c==null?void 0:c.error)||(c==null?void 0:c.message)||$||"Unknown error";return{success:!1,error:`${v.status} - ${a}`}}const I=(c==null?void 0:c._id)||((f=c==null?void 0:c.estimate)==null?void 0:f.id)||(c==null?void 0:c.id),w=(c==null?void 0:c.liveUrl)||((y=c==null?void 0:c.estimate)==null?void 0:y.liveUrl)||(c==null?void 0:c.url);if(!I)return{success:!1,error:"No document ID returned from GHL"};try{await fetch("/wp-json/ca/v1/estimate/annotate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({estimateId:I,locationId:d})})}catch{}return{success:!0,id:I,url:w}}catch(m){return{success:!1,error:m instanceof Error?m.message:"Network error"}}}function N(o,s){var t;console.log("=== mapCartToLineItems Debug ==="),console.log("Input cart:",o),console.log("Context:",s);const u=[];for(const e of o){console.log("Processing item:",e);let r=0;typeof e.unitPrice=="object"&&e.unitPrice!==null&&e.unitPrice[s]?(r=e.unitPrice[s],console.log(`Using context price for ${e.name}: ${r} (from ${s})`)):typeof e.unitPrice=="number"?(r=e.unitPrice,console.log(`Using direct price for ${e.name}: ${r}`)):console.warn(`No valid price found for ${e.name}. unitPrice:`,e.unitPrice);const i={name:e.name||"Unknown Item",description:e.description||"One-off service",amount:Math.round(r),qty:e.qty||e.quantity||1,type:"one_time",taxInclusive:!0,currency:"USD"};console.log(`Created line item for ${e.name}:`,i),u.push(i)}const l=u.reduce((e,r)=>e+r.amount*r.qty,0),n=(t=o.find(e=>e.targetTotal))==null?void 0:t.targetTotal;if(console.log("Total before discount (dollars):",l),console.log("Target total:",n),n&&n<l){const e=l-n;console.log("Adding discount line item:",e),u.push({name:"Discount",description:"Applied discount to reach target price",amount:-e,qty:1,type:"one_time",taxInclusive:!0,currency:"USD"})}return console.log("Final line items:",u),console.log("================================"),u}export{U as createDraftDocument,P as submitLeadToGHL};
