const f="pit-195d44e7-6b55-4e86-aa33-1c039d458e5c",y="aLTXtdwNknfmEFo3WBIX",v="estimate";function C(r){if(!r||typeof r!="object")return!1;const{name:s,email:a,phone:u,address:n,postcode:t}=r;if(!s||!a||!u||!n||!t)return!1;const e=/.+@.+\..+/.test(a),o=/^(\+?61|0)[0-9\s-]{8,}$/.test(u);return e&&o}async function D(r){if(!C(r))return{success:!1,error:"Invalid payload"};const s=String(r.name).trim().split(/\s+/),a=s[0]||"",u=s.length>1?s.slice(1).join(" "):"",n={firstName:a,lastName:u,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Lead Form",tags:["Website Lead"],locationId:y,customFields:[]};if(r.productContext){const t=r.productContext;n.customFields.push({key:"product_name",field_value:t.productName||`${t.productType} ${t.context} System`},{key:"product_type",field_value:t.productType},{key:"product_context",field_value:t.context},{key:"estimated_total",field_value:t.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(t.selectedAddons)?t.selectedAddons.join(", "):""}),n.tags.push(`Product: ${t.productType}`,`Context: ${t.context}`)}if(r.propertyContext){const t=r.propertyContext;n.customFields.push({key:"property_type",field_value:t.propertyType},{key:"building_type",field_value:t.buildingType}),t.storeyType&&n.customFields.push({key:"storey_type",field_value:t.storeyType}),t.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:t.ceilingType}),n.tags.push(`Property: ${t.propertyType}`,`Building: ${t.buildingType}`)}try{const t=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),e=await t.text();let o=null;try{o=JSON.parse(e)}catch{o=null}if(!t.ok){const i=(o==null?void 0:o.error)||(o==null?void 0:o.message)||e||"Unknown error";return{success:!1,error:`GHL API failed: ${t.status} - ${i}`}}return{success:!0,data:o}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async function w(r,s=v){var a;if(!C(r))return{success:!1,error:"Invalid contact payload"};if(!((a=r.productContext)!=null&&a.cart)||!Array.isArray(r.productContext.cart)||r.productContext.cart.length===0)return{success:!1,error:"Empty cart after normalization"};try{const u=await k(r);if(!u.success)return{success:!1,error:`Contact creation failure: ${u.error}`};const n=u.contactId,t=await x(n,r,s);return t.success?{success:!0,type:s,id:t.id,url:t.url||null}:{success:!1,error:`Draft creation failure: ${t.error}`}}catch(u){return{success:!1,error:u instanceof Error?u.message:"Unknown error"}}}async function k(r){var t;const s=String(r.name).trim().split(/\s+/),a=s[0]||"",u=s.length>1?s.slice(1).join(" "):"";try{const e=await fetch(`https://services.leadconnectorhq.com/contacts/search/duplicate?locationId=${y}&email=${encodeURIComponent(r.email)}`,{method:"GET",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(e.ok){const o=await e.json();if(o.contact&&o.contact.id)return console.log("Found existing contact:",o.contact.id),{success:!0,contactId:o.contact.id}}}catch(e){console.warn("Contact search failed, proceeding with creation:",e.message)}const n={firstName:a,lastName:u,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Calculator",tags:["Website Lead","Calculator Quote"],locationId:y,customFields:[]};if(r.productContext){const e=r.productContext;n.customFields.push({key:"product_name",field_value:e.productName||`${e.productType} ${e.context} System`},{key:"product_type",field_value:e.productType},{key:"product_context",field_value:e.context},{key:"estimated_total",field_value:e.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(e.selectedAddons)?e.selectedAddons.join(", "):""}),n.tags.push(`Product: ${e.productType}`,`Context: ${e.context}`)}if(r.propertyContext){const e=r.propertyContext;n.customFields.push({key:"property_type",field_value:e.propertyType},{key:"building_type",field_value:e.buildingType}),e.storeyType&&n.customFields.push({key:"storey_type",field_value:e.storeyType}),e.ceilingType&&n.customFields.push({key:"ceiling_type",field_value:e.ceilingType}),n.tags.push(`Property: ${e.propertyType}`,`Building: ${e.buildingType}`)}try{const e=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(n)}),o=await e.text();let i=null;try{i=JSON.parse(o)}catch{i=null}if(!e.ok){if(e.status===400&&(o.includes("duplicate")||o.includes("already exists"))){console.log("Duplicate contact detected, attempting to find existing contact...");try{const l=await fetch(`https://services.leadconnectorhq.com/contacts/?locationId=${y}&query=${encodeURIComponent(r.email)}`,{method:"GET",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"}});if(l.ok){const d=await l.json();if(d.contacts&&d.contacts.length>0){const p=d.contacts.find(g=>g.email===r.email);if(p)return console.log("Found existing contact via search:",p.id),{success:!0,contactId:p.id}}}}catch(l){console.warn("Fallback contact search failed:",l.message)}}const h=(i==null?void 0:i.error)||(i==null?void 0:i.message)||o||"Unknown error";return{success:!1,error:`${e.status} - ${h}`}}const m=((t=i==null?void 0:i.contact)==null?void 0:t.id)||(i==null?void 0:i.id);return m?{success:!0,contactId:m}:{success:!1,error:"No contact ID returned from GHL"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async function x(r,s,a){var i,m,h,l;const u=I(s.productContext.cart,s.productContext.context),n=new Date,t=n.toISOString().split("T")[0],e=new Date(n.getTime()+30*24*60*60*1e3).toISOString().split("T")[0],o={altId:y,altType:"location",name:`${a==="estimate"?"Estimate":"Invoice"} - ${s.name||"Customer"}`,title:a==="estimate"?"ESTIMATE":"INVOICE",businessDetails:{name:"Cheap Alarms",address:{addressLine1:"Cheap Alarms Pty Ltd",city:"Brisbane",state:"QLD",postalCode:"4000",countryCode:"AU"}},currency:"USD",items:u,discount:{type:"percentage",value:0},termsNotes:"<p>Quote generated from website configurator.</p>",contactDetails:{id:r,name:s.name,email:s.email,phoneNo:(i=s.phone)!=null&&i.startsWith("+")?s.phone:`+61${((m=s.phone)==null?void 0:m.replace(/^0/,""))||""}`,address:{addressLine1:s.address||"Address not provided",city:"TBD",state:"TBD",postalCode:s.postcode||"TBD",countryCode:"AU"}},issueDate:t,expiryDate:e,frequencySettings:{enabled:!1},liveMode:!0};try{const p=await fetch(`https://services.leadconnectorhq.com/invoices/${a==="estimate"?"estimate":""}`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(o)}),g=await p.text();let c=null;try{c=JSON.parse(g)}catch{c=null}if(!p.ok){const $=(c==null?void 0:c.error)||(c==null?void 0:c.message)||g||"Unknown error";return{success:!1,error:`${p.status} - ${$}`}}const T=(c==null?void 0:c._id)||((h=c==null?void 0:c.estimate)==null?void 0:h.id)||(c==null?void 0:c.id),_=(c==null?void 0:c.liveUrl)||((l=c==null?void 0:c.estimate)==null?void 0:l.liveUrl)||(c==null?void 0:c.url);return T?{success:!0,id:T,url:_}:(console.log("âŒ No document ID found in response. Available keys:",Object.keys(c||{})),{success:!1,error:"No document ID returned from GHL"})}catch(d){return{success:!1,error:d instanceof Error?d.message:"Network error"}}}function I(r,s){var t;console.log("=== mapCartToLineItems Debug ==="),console.log("Input cart:",r),console.log("Context:",s);const a=[];for(const e of r){console.log("Processing item:",e);let o=0;typeof e.unitPrice=="object"&&e.unitPrice!==null&&e.unitPrice[s]?(o=e.unitPrice[s],console.log(`Using context price for ${e.name}: ${o} (from ${s})`)):typeof e.unitPrice=="number"?(o=e.unitPrice,console.log(`Using direct price for ${e.name}: ${o}`)):console.warn(`No valid price found for ${e.name}. unitPrice:`,e.unitPrice);const i={name:e.name||"Unknown Item",description:e.description||"One-off service",amount:Math.round(o),qty:e.qty||e.quantity||1,type:"one_time",taxInclusive:!0,currency:"USD"};console.log(`Created line item for ${e.name}:`,i),a.push(i)}const u=a.reduce((e,o)=>e+o.amount*o.qty,0),n=(t=r.find(e=>e.targetTotal))==null?void 0:t.targetTotal;if(console.log("Total before discount (dollars):",u),console.log("Target total:",n),n&&n<u){const e=u-n;console.log("Adding discount line item:",e),a.push({name:"Discount",description:"Applied discount to reach target price",amount:-e,qty:1,type:"one_time",taxInclusive:!0,currency:"USD"})}return console.log("Final line items:",a),console.log("================================"),a}export{w as createDraftDocument,D as submitLeadToGHL};
