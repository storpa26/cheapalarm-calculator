const f="pit-195d44e7-6b55-4e86-aa33-1c039d458e5c",y="aLTXtdwNknfmEFo3WBIX",$="estimate";function _(r){if(!r||typeof r!="object")return!1;const{name:s,email:a,phone:u,address:o,postcode:t}=r;if(!s||!a||!u||!o||!t)return!1;const e=/.+@.+\..+/.test(a),c=/^(\+?61|0)[0-9\s-]{8,}$/.test(u);return e&&c}async function D(r){if(!_(r))return{success:!1,error:"Invalid payload"};const s=String(r.name).trim().split(/\s+/),a=s[0]||"",u=s.length>1?s.slice(1).join(" "):"",o={firstName:a,lastName:u,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Lead Form",tags:["Website Lead"],locationId:y,customFields:[]};if(r.productContext){const t=r.productContext;o.customFields.push({key:"product_name",field_value:t.productName||`${t.productType} ${t.context} System`},{key:"product_type",field_value:t.productType},{key:"product_context",field_value:t.context},{key:"estimated_total",field_value:t.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(t.selectedAddons)?t.selectedAddons.join(", "):""}),o.tags.push(`Product: ${t.productType}`,`Context: ${t.context}`)}if(r.propertyContext){const t=r.propertyContext;o.customFields.push({key:"property_type",field_value:t.propertyType},{key:"building_type",field_value:t.buildingType}),t.storeyType&&o.customFields.push({key:"storey_type",field_value:t.storeyType}),t.ceilingType&&o.customFields.push({key:"ceiling_type",field_value:t.ceilingType}),o.tags.push(`Property: ${t.propertyType}`,`Building: ${t.buildingType}`)}try{const t=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(o)}),e=await t.text();let c=null;try{c=JSON.parse(e)}catch{c=null}if(!t.ok){const i=(c==null?void 0:c.error)||(c==null?void 0:c.message)||e||"Unknown error";return{success:!1,error:`GHL API failed: ${t.status} - ${i}`}}return{success:!0,data:c}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async function b(r,s=$){var a;if(!_(r))return{success:!1,error:"Invalid contact payload"};if(!((a=r.productContext)!=null&&a.cart)||!Array.isArray(r.productContext.cart)||r.productContext.cart.length===0)return{success:!1,error:"Empty cart after normalization"};try{const u=await k(r);if(!u.success)return{success:!1,error:`Contact creation failure: ${u.error}`};const o=u.contactId,t=await x(o,r,s);return t.success?{success:!0,type:s,id:t.id,url:t.url||null}:{success:!1,error:`Draft creation failure: ${t.error}`}}catch(u){return{success:!1,error:u instanceof Error?u.message:"Unknown error"}}}async function k(r){var t;const s=String(r.name).trim().split(/\s+/),a=s[0]||"",u=s.length>1?s.slice(1).join(" "):"",o={firstName:a,lastName:u,email:r.email,phone:r.phone,address1:r.address,postalCode:r.postcode,source:"Website Calculator",tags:["Website Lead","Calculator Quote"],locationId:y,customFields:[]};if(r.productContext){const e=r.productContext;o.customFields.push({key:"product_name",field_value:e.productName||`${e.productType} ${e.context} System`},{key:"product_type",field_value:e.productType},{key:"product_context",field_value:e.context},{key:"estimated_total",field_value:e.estimatedTotal||0},{key:"selected_addons",field_value:Array.isArray(e.selectedAddons)?e.selectedAddons.join(", "):""}),o.tags.push(`Product: ${e.productType}`,`Context: ${e.context}`)}if(r.propertyContext){const e=r.propertyContext;o.customFields.push({key:"property_type",field_value:e.propertyType},{key:"building_type",field_value:e.buildingType}),e.storeyType&&o.customFields.push({key:"storey_type",field_value:e.storeyType}),e.ceilingType&&o.customFields.push({key:"ceiling_type",field_value:e.ceilingType}),o.tags.push(`Property: ${e.propertyType}`,`Building: ${e.buildingType}`)}try{const e=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(o)}),c=await e.text();let i=null;try{i=JSON.parse(c)}catch{i=null}if(!e.ok){const d=(i==null?void 0:i.error)||(i==null?void 0:i.message)||c||"Unknown error";return{success:!1,error:`${e.status} - ${d}`}}const l=((t=i==null?void 0:i.contact)==null?void 0:t.id)||(i==null?void 0:i.id);return l?{success:!0,contactId:l}:{success:!1,error:"No contact ID returned from GHL"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async function x(r,s,a){var i,l,d,g;const u=I(s.productContext.cart,s.productContext.context),o=new Date,t=o.toISOString().split("T")[0],e=new Date(o.getTime()+30*24*60*60*1e3).toISOString().split("T")[0],c={altId:y,altType:"location",name:`${a==="estimate"?"Estimate":"Invoice"} - ${s.name||"Customer"}`,title:a==="estimate"?"ESTIMATE":"INVOICE",businessDetails:{name:"Cheap Alarms",address:{addressLine1:"Cheap Alarms Pty Ltd",city:"Brisbane",state:"QLD",postalCode:"4000",countryCode:"AU"}},currency:"USD",items:u,discount:{type:"percentage",value:0},termsNotes:"<p>Quote generated from website configurator.</p>",contactDetails:{id:r,name:s.name,email:s.email,phoneNo:(i=s.phone)!=null&&i.startsWith("+")?s.phone:`+61${((l=s.phone)==null?void 0:l.replace(/^0/,""))||""}`,address:{addressLine1:s.address||"Address not provided",city:"TBD",state:"TBD",postalCode:s.postcode||"TBD",countryCode:"AU"}},issueDate:t,expiryDate:e,frequencySettings:{enabled:!1},liveMode:!0};try{const m=await fetch(`https://services.leadconnectorhq.com/invoices/${a==="estimate"?"estimate":""}`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",Version:"2021-07-28"},body:JSON.stringify(c)}),h=await m.text();let n=null;try{n=JSON.parse(h)}catch{n=null}if(!m.ok){const v=(n==null?void 0:n.error)||(n==null?void 0:n.message)||h||"Unknown error";return{success:!1,error:`${m.status} - ${v}`}}const T=(n==null?void 0:n._id)||((d=n==null?void 0:n.estimate)==null?void 0:d.id)||(n==null?void 0:n.id),C=(n==null?void 0:n.liveUrl)||((g=n==null?void 0:n.estimate)==null?void 0:g.liveUrl)||(n==null?void 0:n.url);return T?{success:!0,id:T,url:C}:(console.log("❌ No document ID found in response. Available keys:",Object.keys(n||{})),{success:!1,error:"No document ID returned from GHL"})}catch(p){return{success:!1,error:p instanceof Error?p.message:"Network error"}}}function I(r,s){var t;console.log("=== mapCartToLineItems Debug ==="),console.log("Input cart:",r),console.log("Context:",s);const a=[];for(const e of r){console.log("Processing item:",e);let c=0;typeof e.unitPrice=="object"&&e.unitPrice!==null&&e.unitPrice[s]?(c=e.unitPrice[s],console.log(`Using context price for ${e.name}: ${c} (from ${s})`)):typeof e.unitPrice=="number"?(c=e.unitPrice,console.log(`Using direct price for ${e.name}: ${c}`)):console.warn(`No valid price found for ${e.name}. unitPrice:`,e.unitPrice);const i={name:e.name||"Unknown Item",description:e.description||"One-off service",amount:Math.round(c),qty:e.qty||e.quantity||1,type:"one_time",taxInclusive:!0,currency:"USD"};console.log(`Created line item for ${e.name}:`,i),a.push(i)}const u=a.reduce((e,c)=>e+c.amount*c.qty,0),o=(t=r.find(e=>e.targetTotal))==null?void 0:t.targetTotal;if(console.log("Total before discount (dollars):",u),console.log("Target total:",o),o&&o<u){const e=u-o;console.log("Adding discount line item:",e),a.push({name:"Discount",description:"Applied discount to reach target price",amount:-e,qty:1,type:"one_time",taxInclusive:!0,currency:"USD"})}return console.log("Final line items:",a),console.log("================================"),a}export{b as createDraftDocument,D as submitLeadToGHL};
